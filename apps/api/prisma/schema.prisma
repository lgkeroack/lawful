generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  displayName  String   @map("display_name") @db.VarChar(100)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  documents Document[]
  auditLogs AuditLog[]

  @@map("users")
}

model Document {
  id               String    @id @default(uuid()) @db.Uuid
  userId           String    @map("user_id") @db.Uuid
  title            String    @db.VarChar(255)
  description      String?   @db.Text
  fileKey          String    @map("file_key") @db.VarChar(500)
  fileType         String    @map("file_type") @db.VarChar(10)
  fileSizeBytes    Int       @map("file_size_bytes")
  originalFilename String    @map("original_filename") @db.VarChar(255)
  contentText      String?   @map("content_text") @db.Text
  tags             String[]  @default([])
  uploadedAt       DateTime  @default(now()) @map("uploaded_at") @db.Timestamptz
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt        DateTime? @map("deleted_at") @db.Timestamptz

  user          User                   @relation(fields: [userId], references: [id])
  jurisdictions DocumentJurisdiction[]

  @@index([userId])
  @@index([uploadedAt(sort: Desc)])
  @@index([userId, uploadedAt(sort: Desc)])
  @@map("documents")
}

model Jurisdiction {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(100)
  code        String   @unique @db.VarChar(20)
  level       String   @db.VarChar(20)
  parentId    String?  @map("parent_id") @db.Uuid
  legalSystem String   @map("legal_system") @db.VarChar(20)
  geoCode     String?  @map("geo_code") @db.VarChar(20)
  population  Int?
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  parent   Jurisdiction?  @relation("JurisdictionHierarchy", fields: [parentId], references: [id])
  children Jurisdiction[] @relation("JurisdictionHierarchy")

  documents DocumentJurisdiction[]

  @@index([level])
  @@index([parentId])
  @@map("jurisdictions")
}

model DocumentJurisdiction {
  documentId     String @map("document_id") @db.Uuid
  jurisdictionId String @map("jurisdiction_id") @db.Uuid

  document     Document     @relation(fields: [documentId], references: [id], onDelete: Cascade)
  jurisdiction Jurisdiction @relation(fields: [jurisdictionId], references: [id])

  @@id([documentId, jurisdictionId])
  @@index([documentId])
  @@index([jurisdictionId])
  @@map("document_jurisdictions")
}

model AuditLog {
  id            String   @id @default(uuid()) @db.Uuid
  timestamp     DateTime @default(now()) @db.Timestamptz
  actorUserId   String?  @map("actor_user_id") @db.Uuid
  actorIpHash   String   @map("actor_ip_hash") @db.Text
  action        String   @db.Text
  resourceType  String   @map("resource_type") @db.Text
  resourceId    String   @map("resource_id") @db.Uuid
  changes       Json?
  requestId     String   @map("request_id") @db.Text
  outcome       String   @db.Text
  failureReason String?  @map("failure_reason") @db.Text

  actor User? @relation(fields: [actorUserId], references: [id])

  @@index([timestamp(sort: Desc)])
  @@index([actorUserId, timestamp(sort: Desc)])
  @@index([resourceType, resourceId, timestamp(sort: Desc)])
  @@index([action, timestamp(sort: Desc)])
  @@map("audit_logs")
}
